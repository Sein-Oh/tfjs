<!DOCTYPE html>
<html>

<head>
    <title>Tensorflow.js</title>
</head>

<body>
    <button value='circle' onclick="openImageFiles(this.value)">Add Circle</button>
    <button value='rectangle' onclick="openImageFiles(this.value)">Add Rectangle</button>
    <button value='triangle' onclick="openImageFiles(this.value)">Add Triangle</button>
    <br><br>
    <button onclick="makeDataset(dataAry)">Make Dataset</button>
    <button onclick="makeModel()">Make Model</button>
    <button onclick="fitModel()">Training</button>
</body>
<script src='https://cdnjs.cloudflare.com/ajax/libs/tensorflow/1.2.2/tf.js'></script>
<script>
    let dataAry = [];
    function openImageFiles(className) {
        const input = document.createElement('input');
        input.type = 'file';
        input.multiple = 'multiple';
        input.onchange = function (evt) {
            const data = evt.target.files;
            for (let i = 0; i < data.length; i++) {
                const fileName = data[i].name;
                const url = URL.createObjectURL(data[i]);
                dataAry.push([className, fileName, url]);
                console.log('Add ' + className + ' data.');
            }
        };
        input.click();
    }

    let xs, ys;
    function makeDataset(arry) {
        //make xs
        for (let i = 0; i < arry.length; i++) {
            const img = new Image();
            img.onload = function () {
                const t = tf.browser.fromPixels(img).expandDims();
                //tensor.push(t);
                if (i == 0) {
                    xs = t;
                } else {
                    xs = xs.concat(t);
                }
            }
            img.src = arry[i][2];
        }
        console.log('xs.shape : ' + xs.shape);

        //make ys
        const y = dataAry.map(ary => {
            if (ary[0] == 'circle') return 0;
            else if (ary[0] == 'triangle') return 1;
            else if (ary[0] == 'rectangle') return 2;
        });
        ys = tf.oneHot(y, 3);
        console.log('ys.shape : ' + ys.shape);
    }

    let model;
    function makeModel() {
        model = tf.sequential();
        model.add(tf.layers.conv2d({
            inputShape: [24, 24, 3],
            kernelSize: 2,
            filters: 4,
            strides: 1,
            activation: 'relu',
            kernelInitializer: 'varianceScaling'
        }));
        model.add(tf.layers.conv2d({ kernelSize: 2, filters: 4, strides: 1, activation: 'relu', kernelInitializer: 'varianceScaling' }));
        model.add(tf.layers.flatten());
        model.add(tf.layers.dense({ units: 30, kernelInitializer: 'varianceScaling', activation: 'softmax' }));
        model.add(tf.layers.dense({ units: 3, activation: 'linear' }));
        model.compile({ optimizer: tf.train.sgd(0.02), loss: 'meanSquaredError' });
        model.summary();
    }

    let fit;
    async function fitModel(){
        fit = await model.fit(xs, ys, {
            epochs : 50,
            callbacks : {onBatchEnd}
            });
        console.log('Training is done.');
        model.save("downloads://model");
        console.log('Model and weight saved.');
    }

    function onBatchEnd(batch, logs){
        console.log("loss", logs.loss);
    }
</script>

</html>
