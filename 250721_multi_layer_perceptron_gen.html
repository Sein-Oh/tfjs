<html>

<head>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"> </script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@1.5.1/dist/tfjs-vis.umd.min.js"></script>
</head>

<body>
  <button onclick="raw_to_array()">Read Data</button>
  <button onclick="csv_to_array()">Read CSV from Clipboard</button>
  <br>
  <button onclick="train_btn()">Train</button>
  <label>Epoch</label><input type="number" id="epoch" value="100">
  <br>
  <textarea id="output" rows="20" style="width:100%"></textarea>
</body>
<script>
  const info = document.getElementById("output")
  const raw_data = 'X1\tX2\tX3\tY\r\n6.222410601\t0.5780079426\t1.776148142\t1.820454607\r\n5.12285042\t4.627906068\t0.6569080537\t23.05116249\r\n2.937964464\t4.129564515\t0.3706112729\t11.76190252\r\n7.830005369\t4.287460897\t0.7926283477\t32.7782135\r\n7.457813551\t1.289157995\t1.507400804\t8.106899157\r\n7.366007745\t1.455999147\t0.1816047493\t10.54329624\r\n7.453699472\t4.775932008\t1.160729584\t34.4376323\r\n7.28148397\t1.780966873\t1.085574596\t11.88250714\r\n2.205774014\t3.794589811\t0.802276291\t7.56773131\r\n9.2460451\t2.073700622\t1.792150879\t17.3813786\r\n9.121990154\t2.240771891\t0.1362288663\t20.30407026\r\n1.432737654\t0.4085821348\t0.6707425167\t-0.08535150725\r\n7.18797163\t4.627668856\t0.5891377008\t32.67441475\r\n9.966224145\t0.1096202867\t0.5249108809\t0.5675894672\r\n8.863080842\t1.958469279\t1.923178182\t15.43489336\r\n9.495060278\t1.003262922\t0.1839728647\t9.342069057\r\n7.129724743\t1.274031891\t1.586540061\t7.496956636\r\n8.449688613\t3.17360614\t1.320762366\t25.4952213\r\n1.106238168\t0.9894031265\t1.114546688\t-0.02003118606\r\n2.114826042\t1.64963049\t1.909492293\t1.579189227\r\n1.25820893\t3.767537792\t1.283232955\t3.457116741\r\n1.272581824\t2.071346083\t1.596904659\t1.039052718\r\n2.957609504\t3.945607469\t1.606229095\t10.06333705\r\n2.865803698\t2.234623944\t1.732624953\t4.67136861\r\n5.18013447\t4.399572351\t0.7160496828\t22.0743267\r\n3.745067444\t3.731531435\t0.1855337871\t13.7893031\r\n4.184928448\t4.100610502\t0.1678892503\t16.9928723\r\n6.845061274\t0.9512511301\t0.7676356968\t5.743736575\r\n8.397936708\t2.655750271\t1.7853855\t20.51743719\r\n5.111705175\t0.2632304713\t1.366398693\t-0.02084213059\r\n6.657414068\t4.940757561\t0.9637407952\t31.9289281\r\n4.411212865\t1.274161816\t0.7109428039\t4.909656192\r\n0.1003895954\t1.09927707\t0.5697705785\t-0.4594145982\r\n9.240189362\t0.4039004959\t0.879629041\t2.852488025\r\n9.480307279\t1.520992737\t1.710808164\t12.70867035\r\n3.752871907\t0.7145505996\t1.24849081\t1.433126061\r\n6.174361666\t1.22561416\t1.51176699\t6.055618096\r\n4.079427778\t3.388770931\t1.377044592\t12.44720168\r\n1.752130622\t0.3840188575\t1.232258801\t-0.5594076015\r\n2.396237174\t3.2080565\t1.764285337\t5.922978905\r\n4.830624976\t2.718402551\t0.4091807877\t12.72240247\r\n1.702911554\t3.22767455\t1.381781587\t4.114662699\r\n3.090102335\t4.254220687\t0.0281103164\t13.11786696\r\n4.639394499\t2.557570171\t0.5601368814\t11.3054401\r\n2.626104712\t0.3798161788\t1.313595781\t-0.3161587241\r\n0.3305086971\t2.749972857\t0.6620826778\t0.2468072684\r\n3.458893665\t0.5200165974\t0.9267921358\t0.8718899786\r\n7.46228771\t1.638900474\t1.005316033\t11.22463083\r\n1.236748898\t0.8306667011\t1.294220597\t-0.2668944694\r\n6.635922163\t1.468935707\t1.604079059\t8.143663956\r\n4.30807671\t1.625040604\t1.424207717\t5.57659186\r\n7.307357091\t1.793903508\t1.278705242\t11.82998827\r\n2.632052648\t3.78282904\t0.8746139761\t9.081991215\r\n0.6151795892\t2.832727092\t0.4556272283\t1.28700866\r\n2.132222613\t3.458454799\t1.991601105\t5.382594422\r\n6.823601242\t2.033625557\t0.074556757\t13.80209312\r\n0.1982042386\t2.673686273\t0.05547894164\t0.4744570102\r\n3.775649941\t0.4941406449\t1.97459072\t-0.1088886237\r\n6.11148004\t2.980753106\t0.4426579937\t17.77415511\r\n3.691125868\t4.627462595\t0.5690538809\t16.51149301\r\n7.698103333\t3.291387822\t0.606728699\t24.73071487\r\n4.541723595\t4.735872879\t0.890616713\t20.61840889\r\n4.614319323\t0.4599259229\t0.265790653\t1.856454421\r\n7.842379552\t0.7324866016\t1.066469432\t4.677968515\r\n6.21023367\t0.7848937233\t1.638530281\t3.235843147\r\n3.197986905\t0.4191917444\t0.6544726676\t0.6860970419\r\n5.841638268\t1.823717307\t0.05273996875\t10.60075684\r\n0.1142030445\t2.45123665\t0.8360585905\t-0.5561199022\r\n0.3614873542\t1.139279845\t1.716101848\t-1.304266591\r\n8.18018467\t1.662884853\t1.651875028\t11.95083016\r\n1.78271297\t2.605284432\t1.571703491\t3.072770858\r\n4.093460471\t3.265511795\t0.03905407997\t13.32818937\r\n1.906017864\t4.077109175\t1.229332166\t6.541710755\r\n1.920390758\t2.395250475\t0.2489904142\t4.350826461\r\n2.520120756\t3.726863095\t0.4541324925\t8.938012547\r\n6.097566458\t2.114204981\t1.862186739\t11.02931864\r\n5.827943254\t4.723476817\t0.8398782361\t26.68827662\r\n4.421542395\t4.888756376\t0.2995252204\t21.31631836\r\n6.499378331\t4.524846033\t0.297451037\t29.11123522\r\n3.823618699\t4.440529843\t0.263684524\t16.71520842\r\n8.099766747\t4.103723924\t1.981687668\t31.25751891\r\n8.343467786\t0.600411322\t0.8624475798\t4.147064944\r\n4.137658204\t4.64341333\t1.909401896\t17.30345536\r\n2.837436045\t0.4729403973\t0.7639148813\t0.578023249\r\n7.07683392\t1.131376125\t0.2492820109\t7.757278929\r\n9.885885045\t4.602679077\t0.5591404735\t44.94241578\r\n7.849198423\t0.261114805\t1.3960528\t0.6534891154\r\n8.48117771\t1.709183207\t0.7109427363\t13.78494378\r\n7.155872654\t0.4387256753\t1.007815817\t2.131649246\r\n1.559671914\t2.587549512\t1.050822851\t2.984905449\r\n0.1496877844\t0.8747742772\t1.446587607\t-1.315644583\r\n2.460435285\t3.684478986\t1.443796769\t7.621625334\r\n9.55893063\t2.42105832\t1.910962848\t21.23176568\r\n0.07180254933\t1.967796693\t1.578083755\t-1.436790935\r\n4.071613175\t4.591401538\t1.707621749\t16.98678924\r\n5.620905487\t1.297692314\t1.505797982\t5.788407866\r\n1.052328041\t4.57859476\t0.543056859\t4.275126795\r\n5.058814351\t2.882402976\t0.4083345212\t14.17320702\r\n3.187276471\t3.593669293\t0.1562532139\t11.29776437\r\n5.831178854\t4.712553169\t0.05704773976\t27.42269265\r\n6.466741561\t3.361670481\t0.3066221684\t21.43243204\r\n5.367181231\t0.8345653156\t0.6500775621\t3.829185736\r\n6.81479676\t4.240036786\t0.6938012205\t28.20118773\r\n3.454662481\t4.867556128\t1.226446268\t15.58931726\r\n1.363311715\t2.675469201\t0.1040750542\t3.543423452\r\n0.3541930324\t4.071754033\t0.9569712084\t0.4852156995\r\n8.279528004\t1.073450981\t1.221062154\t7.666605302\r\n2.053593606\t1.245680522\t1.820808571\t0.737312984\r\n8.929463455\t0.7473389681\t1.095744241\t5.577591764\r\n9.034308472\t3.56779334\t1.204051798\t31.0284938\r\n3.266539805\t0.4974238764\t0.005447261636\t1.619407631\r\n2.086569929\t3.993092129\t1.798514959\t6.533351001\r\n3.816742556\t1.365040443\t1.836189717\t3.373818233\r\n0.6890289859\t2.365202145\t1.903018255\t-0.2733254195\r\n3.34557854\t4.825555606\t1.945302085\t14.19897319\r\n7.610059162\t4.47260867\t0.740247661\t33.29656892\r\n1.440226184\t4.98367223\t1.318041684\t5.859573553\r\n1.595544067\t0.9099471641\t0.600149199\t0.8517116002\r\n5.877170361\t4.187870134\t1.004134273\t23.60869195\r\n8.511760207\t1.650015231\t0.3321074475\t13.71242653\r\n7.841731639\t1.476460696\t1.912404016\t9.665604535\r\n9.161695658\t1.314102085\t1.18805631\t10.85134705\r\n0.1802701325\t1.345406574\t1.251214893\t-1.008678272\r\n8.821766274\t0.6153316133\t1.501505976\t3.926805698\r\n2.551713547\t4.109208231\t0.9145767723\t9.570945539\r\n9.60129717\t1.594029056\t1.928501817\t13.37624485\r\n0.9176779179\t2.939974685\t1.950181349\t0.747768498\r\n3.577810743\t2.604960401\t0.05848890716\t9.261566401\r\n3.168868902\t2.087629644\t0.335927123\t6.279497535\r\n1.901786531\t4.073201948\t1.979036653\t5.767323952\r\n4.896935493\t0.0156015267\t0.2431275982\t-0.1667279284\r\n4.77646352\t4.472628898\t0.6005303894\t20.76281838\r\n6.497323909\t3.302502505\t0.111249455\t21.34617903\r\n3.07177344\t0.4656592758\t1.508800102\t-0.0784003067\r\n7.398086982\t0.4197564474\t0.03323047924\t3.072164229\r\n3.485244829\t0.7968448641\t0.8934766382\t1.883722804\r\n6.807329827\t4.606321829\t1.097185408\t30.25956657\r\n0.5336939788\t1.218560457\t1.027763624\t-0.3774252452\r\n9.827833001\t0.5850192718\t1.525614587\t4.223857119\r\n9.128986643\t2.047420608\t0.6570419178\t18.03383347\r\n7.803681439\t1.595950617\t1.694300824\t10.75998938\r\n1.150849333\t2.368805138\t1.381935453\t1.344202359\r\n0.797496718\t0.7256892964\t1.576149393\t-0.9974145611\r\n3.108244219\t4.008383378\t0.02298625994\t12.4360482\r\n2.991355516\t3.578283261\t1.306674304\t9.397243069\r\n9.802298457\t2.306034169\t1.707645541\t20.89678963\r\n1.050170749\t3.08068025\t0.1705116956\t3.064728591\r\n5.380067413\t2.074035357\t0.1464173308\t11.01203271\r\n4.284090652\t4.902499227\t0.2368901563\t20.76586095\r\n5.706623285\t3.710184556\t1.551780062\t19.62084552\r\n3.806419238\t4.578885813\t0.5560730257\t16.87308602\r\n5.057874801\t0.2391132511\t1.934343583\t-0.7249386954\r\n5.853220626\t3.069243172\t0.1839180113\t17.78103943\r\n4.753660445\t0.06914848437\t1.038430967\t-0.7097225517\r\n7.867916923\t0.7291305684\t1.837246792\t3.899491947\r\n2.841141696\t4.546462801\t0.9202795358\t11.9968655\r\n9.832478202\t2.368708809\t0.4367318348\t22.85354589\r\n9.712006378\t0.05697055311\t1.10043218\t-0.547133805\r\n9.332648167\t0.7810236716\t1.098358027\t6.190661111\r\n7.770821462\t1.442797317\t0.9642541416\t10.24746621\r\n8.344608688\t0.4343607875\t1.489830849\t2.134739952\r\n1.004741364\t4.370769199\t1.081347671\t3.310144936\r\n2.65301902\t4.73200712\t1.148892803\t11.40521209\r\n0.7563983929\t3.686331737\t0.1983347409\t2.59000066\r\n1.782108784\t2.854134151\t1.530023015\t3.556354527\r\n9.158195323\t2.058441752\t1.780314098\t17.07129753\r\n2.760723773\t4.518795213\t1.70014256\t10.77500281\r\n6.079225649\t2.498073625\t1.950433613\t13.23591964\r\n3.410659225\t3.652117089\t0.5618246266\t11.89430221\r\n5.062520151\t4.019404447\t0.03312792105\t20.31518809\r\n3.013397804\t4.047960769\t0.881007496\t11.3171086\r\n8.231941327\t1.065782436\t1.759352936\t7.014105544\r\n5.985713309\t3.209948737\t0.6000660289\t18.61376685\r\n6.326589119\t4.882215806\t1.132092594\t29.7556808\r\n8.983138525\t1.023256547\t0.6784604116\t8.513594901\r\n5.957993568\t4.183445409\t0.7452888892\t24.17965195\r\n8.741962095\t2.677322027\t0.8586130261\t22.54643465\r\n9.993417509\t4.633826946\t1.689075525\t44.61869181\r\n1.645305102\t1.049431968\t1.377426838\t0.3492089328\r\n0.7427042042\t1.173074123\t1.480001222\t-0.6087541393\r\n0.3050963446\t1.48906384\t1.546113045\t-1.091805111\r\n1.62196795\t3.933292583\t1.406282141\t4.973392364\r\n3.241579438\t3.12505881\t1.67610629\t8.454020091\r\n0.9953782353\t3.04074262\t0.9274539366\t2.099235087\r\n6.217505178\t3.176926223\t1.805082723\t17.94747252\r\n9.290688155\t3.324273204\t0.6465124695\t30.23827321\r\n6.784566196\t0.1129959801\t0.243854512\t0.5227741951\r\n6.463432246\t1.255828431\t1.287563246\t6.829398731\r\n8.777763017\t4.299561511\t0.9802144546\t36.76031756\r\n9.891507175\t0.4531436256\t0.9050594667\t3.577213958\r\n5.545060707\t4.749943122\t1.185850894\t25.15287207\r\n2.106865599\t2.57398069\t0.5343377607\t4.888693608\r\n6.301513795\t1.289190224\t1.571596637\t6.552253343\r\n0.5373285475\t2.047711736\t1.592559516\t-0.492265543\r\n1.850616882\t1.710905817\t1.453445206\t1.712785981\r\n8.796805907\t1.866997306\t1.722552731\t14.70106019\r\n1.460521854\t3.271522868\t1.633597881\t3.144532764\r\n1.772731647\t3.291250689\t0.03456908845\t5.799935165\r\n3.049269808\t2.315263419\t0.2436252099\t6.816237632\r\n4.766546777\t1.767274964\t0.02371317369\t8.40008561'


  const value = {}
  const csv_to_array = async () => {
    // Clear the value object
    Object.keys(value).forEach(key => { delete value[key] })
    // Clear the output textarea
    info.value = ""
    const text = await navigator.clipboard.readText()
    const text_ary = text.split("\r\n")
    const header = text_ary[0].split("\t")
    header.forEach(name => {
      value[name] = []
    })
    for (let i = 1; i < text_ary.length; i++) {
      const data = text_ary[i].split("\t")
      for (let j = 0; j < data.length; j++) {
        value[header[j]].push(data[j])
      }
    }
    info.value = text
    build_model()
  }

  const raw_to_array = () => {
    const text_ary = raw_data.split("\r\n")
    const header = text_ary[0].split("\t")
    header.forEach(name => {
      value[name] = []
    })
    for (let i = 1; i < text_ary.length; i++) {
      const data = text_ary[i].split("\t")
      for (let j = 0; j < data.length; j++) {
        value[header[j]].push(data[j])
      }
    }
    info.value = raw_data
    build_model()
  }

  let model
  const build_model = () => {
    const input_shape = Object.keys(value).length - 1 //3
    model = tf.sequential()
    model.add(tf.layers.dense({ units: 16, activation: 'relu', inputShape: [input_shape] }))
    model.add(tf.layers.dense({ units: 8, activation: 'relu' }))
    // model.add(tf.layers.dense({ units: 4, activation: 'relu' }))
    model.add(tf.layers.dense({ units: 1 }))
    model.compile({
      optimizer: tf.train.adam(),
      loss: 'meanSquaredError',
      metrics: ['accuracy']
    })
    tfvis.show.modelSummary({ name: 'Model Summary', tab: "Model" }, model)
    model.summary()
  }

  let _history = []
  const train_info = async (epoch, logs) => {
    const message = `Epoch: ${epoch} - loss: ${logs.loss.toFixed(3)}`
    // console.log(message)
    console.log(logs)
    _history.push(logs);
    tfvis.show.history({ name: 'loss', tab: 'History' }, _history, ['loss'])
  }

  let x = []
  let y = []
  let x_test = []
  let y_test = []

  function* xGen() {
    for (let i=10; i<180; i++) {
      yield tf.tidy(() => {
        const ary = []
        ary.push([value["X1"][i], value["X2"][i], value["X3"][i]])
        return tf.tensor(ary)
      })
    }
  }

  function* xvGen() {
    for (let i=180; i<200; i++) {
      yield tf.tidy(() => {
        const ary = []
        ary.push([value["X1"][i], value["X2"][i], value["X3"][i]])
        return tf.tensor(ary)
      })
    }
  }

  function* yGen() {
    for (let i=10; i<180; i++) {
      yield tf.tidy(() => {
        const ary = []
        ary.push(value["Y"][i])
        return tf.tensor(ary)
      })
    }
  }

  function* yvGen() {
    for (let i=180; i<200; i++) {
      yield tf.tidy(() => {
        const ary = []
        ary.push(value["Y"][i])
        return tf.tensor(ary)
      })
    }
  }

  const train = async (epoch) => {
    value["X1"] = value["X1"].map(parseFloat)
    value["X2"] = value["X2"].map(parseFloat)
    value["X3"] = value["X3"].map(parseFloat)
    value["Y"] = value["Y"].map(parseFloat)

    for (let i=0; i<10; i++) {
      x_test.push([value["X1"][i], value["X2"][i], value["X3"][i]])
      y_test.push(value["Y"][i])
    }

    const x_val = []
    const y_val = []
    for (let i=180; i<200; i++) {
      x_val.push([value["X1"][i], value["X2"][i], value["X3"][i]])
      y_val.push(value["Y"][i])
    }

    const xval = tf.data.array(x_val)
    const yval = tf.data.array(y_val)
    const dsv = await tf.data.zip({xs: xval, ys: yval})
    const dsvv = dsv.batch(20)

    

    const xs = await tf.data.generator(xGen)
    const ys = await tf.data.generator(yGen)
    const ds = await tf.data.zip({xs, ys})

  
  
    const fit_param = {
      epochs: epoch,
      validationData: dsvv,
      callbacks: {
        onEpochEnd: train_info
      }
    }
    await model.fitDataset(ds, fit_param)
    console.log("Training complete")
    test()
  }

  const predict = (x1, x2, x3) => {
    model.predict(tf.tensor([[x1, x2, x3]])).print()
  }

  const test = async () => {
    const xs_test = tf.tensor(x_test)
    const result = await model.predict(xs_test)
    const res_data = await result.data()
    for (let i=0; i<res_data.length; i++) {
      console.log(`${res_data[i].toFixed(2)} ${y_test[i].toFixed(2)}`)
    }    
  }

  let clip_text
  const read_clipboard_text = async () => {
    clip_text = await navigator.clipboard.readText()
  }

  const train_btn = () => {
    const epoch = parseInt(document.getElementById("epoch").value)
    train(epoch)
  }
</script>

</html>